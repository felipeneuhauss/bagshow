// Generated by CoffeeScript 1.6.3
(function() {
  var LoginController,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  LoginController = (function(_super) {
    __extends(LoginController, _super);

    function LoginController($scope) {
      this.setScope($scope);
      this.startEvents();
      this.loadScopeData();
    }

    LoginController.prototype.startEvents = function() {
      var _this;
      _this = this;
      _this.scope.showSignUpOrSignInForm = function() {
        var _ref, _ref1;
        if (!_this.scope.signIn && !_this.scope.signUp) {
          _this.scope.signUp = true;
          _this.scope.signIn = false;
        }
        _this.scope.signIn = (_ref = !_this.scope.signIn) != null ? _ref : {
          "false": true
        };
        _this.scope.signUp = (_ref1 = !_this.scope.signUp) != null ? _ref1 : {
          "true": false
        };
        _this.scope.forgotPassword = false;
        _this.scope.signInOrSignUpText = "Voltar ao login";
        if (_this.scope.signIn) {
          return _this.scope.signInOrSignUpText = "Cadastre-se";
        } else {
          return _this.scope.signInOrSignUpText = "Voltar ao login";
        }
      };
      _this.scope.showForgetPasswordForm = function() {
        _this.scope.signIn = false;
        _this.scope.signUp = false;
        _this.scope.forgotPassword = true;
        return _this.scope.signInOrSignUpText = "Voltar ao login";
      };
      _this.scope.signInAction = function() {
        var promise;
        if ($('#signInForm').valid()) {
          return promise = Kinvey.User.login(_this.scope.signInForm.email, _this.scope.signInForm.password, {
            success: function(response) {
              return window.location.href = "/admin";
            },
            error: function(error) {
              return _this.scope.$apply(function() {
                _this.scope.messageError = error.description;
                return _this.scope.showLoginErrorContainer = true;
              });
            }
          });
        }
      };
      return _this.scope.signUpAction = function() {
        var preperedEntity, promise, _newUser;
        _newUser = _this.scope.signUpForm;
        _newUser.username = _this.scope.signUpForm.email;
        _newUser.fname = _this.scope.signUpForm.fname;
        _newUser.emailVerification = false;
        _newUser = preperedEntity = underscore.omit(_newUser, '$$hashKey');
        if ($('#signUpForm').valid()) {
          promise = Kinvey.User.signup(_newUser);
          return promise.then((function(user, response, options) {
            return promise = Kinvey.User.verifyEmail(user.username, {
              success: function() {
                return window.location.href = "/";
              }
            });
          }), function(xhr, status, error) {
            if (error.name === "UserAlreadyExists") {
              return statusMessage("error", "O e-mail informado já está em uso por outro usuário");
            }
          });
        }
      };
    };

    LoginController.prototype.loadScopeData = function() {
      this.scope.signUpForm = {
        fname: '',
        email: '',
        password: '',
        repeatPassword: ''
      };
      this.scope.signInForm = {
        email: '',
        password: '',
        password: ''
      };
      this.scope.signIn = true;
      this.scope.signUp = false;
      this.scope.forgotPassword = false;
      this.scope.signInOrSignUpText = "Cadastre-se";
      this.scope.showLoginErrorContainer = false;
      $('#signUpForm').validate();
      return $('#signInForm').validate();
    };

    return LoginController;

  })(AngularView);

  angularApp.controller('LoginController', LoginController);

}).call(this);
