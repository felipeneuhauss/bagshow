// Generated by CoffeeScript 1.6.3
(function() {
  var BagController,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  BagController = (function(_super) {
    __extends(BagController, _super);

    function BagController($scope) {
      var idElement, _this;
      this.setScope($scope);
      this.loadModel();
      this.loadScopeData();
      this.form = $('#bagForm');
      this.collectionName = 'Bags';
      this.scopeForm = 'bagForm';
      this.formValidate();
      this.startEvents();
      this.loadUploadEvents();
      _this = this;
      _this.scope.showUploadImageOptions = true;
      _this.scope.wait = false;
      _this.scope.bagForm = null;
      this.scope.save = function() {
        if (_this.form.valid()) {
          statusMessage('info', 'Salvando cartão de visita');
          return Kinvey.DataStore.save('Bags', _this._prepareEntityToSave(_this.scope.bagForm), {
            relations: {
              customer: 'Customers'
            },
            exclude: ['customer'],
            success: function(bag) {
              return window.location.href = '/bolsas';
            }
          });
        }
      };
      idElement = this.form.find('input[name="id"]').val();
      if (idElement !== "") {
        this.loadEntity(idElement);
      }
      this.scope.remove = function(id) {
        var bagForm;
        if (confirm("Deseja realmente excluir esse cartão de visita?")) {
          bagForm = _this.scope.bagForm;
          bagForm.inactivedAt = formatKinveyDate();
          return Kinvey.DataStore.save('Bags', _this._prepareEntityToSave(bagForm), {
            relations: {
              customer: 'Customers'
            },
            exclude: ['customer'],
            success: function(bag) {
              return window.location.href = '/bolsas';
            }
          });
        }
      };
    }

    BagController.prototype.loadModel = function() {
      var idElement, _this;
      _this = this;
      _this.scope.bagForm = {
        customer: '',
        cost: '',
        quantity: 0,
        deliveryEstimated: ''
      };
      idElement = null;
      if (this.form) {
        idElement = this.form.find('input[name="id"]').val();
      }
      this.model = new Bag({
        successMessage: 'Sacola ecológica cadastrada com sucesso',
        id: idElement,
        collectionName: 'Bags',
        view: this
      });
      return this;
    };

    BagController.prototype.loadScopeData = function() {
      var _this;
      _this = this;
      statusMessage('info', 'Carregando informações');
      _this.scope.bagForm.imageUrl = !underscore.isUndefined(_this.scope.bagForm.imageUrl) && _this.scope.bagForm.imageUrl !== "" ? _this.scope.bagForm.imageUrl : 'http://www.placehold.it/200x150/EFEFEF/AAAAAA&amp;text=no+image';
      return _this.getOptionsFromKinveyCollection('customers', 'Customers', 'name');
    };

    BagController.prototype.startEvents = function() {
      var _this;
      _this = this;
      _this.scope.edit = function(product) {};
      return _this.scope.getTotalCost = function() {
        var realCost;
        if (!underscore.isNull(_this.scope.bagForm) && !underscore.isUndefined(_this.scope.bagForm.chargedCost) && !underscore.isUndefined(_this.scope.bagForm.unityCost) && !underscore.isUndefined(_this.scope.bagForm.quantity)) {
          realCost = resetMoneyMask(_this.scope.bagForm.chargedCost) * parseInt(_this.scope.bagForm.quantity);
          _this.scope.bagForm.profit = (resetMoneyMask(_this.scope.bagForm.chargedCost) - resetMoneyMask(_this.scope.bagForm.unityCost)) * parseInt(_this.scope.bagForm.quantity);
          return realCost;
        }
      };
    };

    BagController.prototype._prepareEntityLoaded = function(_entity) {
      _entity.customer = _entity.customer._id;
      _entity.deliveryEstimated = moment(_entity.deliveryEstimated).format('DD/MM/YYYY');
      _entity.imageUrl = !underscore.isUndefined(_entity.imageUrl) && _entity.imageUrl !== "" ? _entity.imageUrl : 'http://www.placehold.it/200x150/EFEFEF/AAAAAA&amp;text=no+image';
      return _entity;
    };

    BagController.prototype._prepareEntityToSave = function(_entity) {
      _entity.customer = {
        _id: _entity.customer
      };
      _entity.profit = resetMoneyMask(_entity.profit);
      _entity.unityCost = resetMoneyMask(_entity.unityCost);
      _entity.chargedCost = resetMoneyMask(_entity.chargedCost);
      _entity.quantity = parseInt(_entity.quantity);
      _entity.deliveryEstimated = formatKinveyDate(_entity.deliveryEstimated);
      _entity = underscore.omit(_entity, ['$$hashKey']);
      return _entity;
    };

    return BagController;

  })(AngularView);

  angularApp.controller('BagController', BagController);

}).call(this);
